<script language="javascript" type="text/javascript">
var vlanObj;
var ispService;
var noIptvData = 
{
    "workingMode": "automatic",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 2,
            "priority": 0,
            "extendID": 0,
            "untag": 1,
            "show": false,
            "lanPort": 255,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": false
        },
        "ipphone": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "iptv": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanEnableEditEnable": false
        }
    },
    "lan_mode": ["internet", "internet", "internet", "internet"],
    "lan_edit": [false, false, false, false]

};

var default_mode_data = new Array(
/*{
    "workingMode": "bridge",
    "displayName": "Ponte",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 2,
            "priority": 0,
            "extendID": 1,
            "untag": 1,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": false
        },
        "ipphone": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "iptv": {
            "enable": true,
            "vlanID": 2,
            "priority": 0,
            "extendID": 2,
            "untag": 1,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanEnableEditEnable": false
        }
    },
    "lan_mode": ["internet", "internet", "iptv", "iptv"],
    "lan_edit": [true, true, true, true]

},
{
    "workingMode": "maxis",
    "displayName": "Malaysia-Maxis",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 621,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "enableEdit": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": true,
            "vlanTagEditEnable": false
        },
        "ipphone": {
            "enable": true,
            "vlanID": 821,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "enableEdit": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": true
        },
        "iptv": {
            "enable": true,
            "vlanID": 823,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "enableEdit": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": true
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "enableEdit": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanEnableEditEnable": false
        }
    },
    "lan_mode": ["iptv", "internet", "internet", "ipphone"],
    "lan_edit": [false, false, false, false]
},
{
    "workingMode": "unifi",
    "displayName": "Malaysia-Unifi",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 500,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": false
        },
        "ipphone": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "iptv": {
            "enable": true,
            "vlanID": 600,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanEnableEditEnable": false
        }
    },
    "lan_mode": ["iptv", "internet", "internet", "internet"],
    "lan_edit": [false, false, false, false]
},
{
    "workingMode": "exstream",
    "displayName": "Singapore-ExStream",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 10,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": false
        },
        "ipphone": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "iptv": {
            "enable": true,
            "vlanID": 20,
            "priority": 4,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanEnableEditEnable": false
        }
    },
    "lan_mode": ["internet", "internet", "internet", "iptv"],
    "lan_edit": [false, false, false, false]
},
{
    "workingMode": "poland",
    "displayName": "Poland",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 35,
            "priority": 0,
            "extendID": 0,
            "untag": 1,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": true
        },
        "ipphone": {
            "enable": true,
            "vlanID": 37,
            "priority": 5,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "iptv": {
            "enable": true,
            "vlanID": 36,
            "priority": 4,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false
        },
        "multicast": {
            "enable": false,
            "vlanID": 1110,
            "priority": 4,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true,
            "vlanEnableEditEnable": true
        }
    },
    "lan_mode": ["internet", "internet", "internet", "internet"],
    "lan_edit": [false, true, true, true]
},*/
{
    "workingMode": "vietnam",
    "displayName": "Vietnã",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 35,
            "priority": 0,
            "extendID": 0,
            "untag": 1,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true,
            "vlanTagEditEnable": true
        },
        "ipphone": {
            "enable": true,
            "vlanID": 37,
            "priority": 5,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true
        },
        "iptv": {
            "enable": true,
            "vlanID": 36,
            "priority": 4,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": false,
            "vlanPrioEditEnable": false,
            "vlanTagEditEnable": false,
            "vlanEnableEditEnable": true
        }
    },
    "lan_mode": ["internet", "internet", "internet", "internet"],
    "lan_edit": [false, true, true, true]
},
{
    "workingMode": "custom",
    "displayName": "Custom",
    "vlanSetting": {
        "internet": {
            "enable": true,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 1,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true,
            "vlanTagEditEnable": true
        },
        "ipphone": {
            "enable": true,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true
        },
        "iptv": {
            "enable": true,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": true,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true
        },
        "multicast": {
            "enable": false,
            "vlanID": 0,
            "priority": 0,
            "extendID": 0,
            "untag": 0,
            "show": false,
            "vlanIdEditEnable": true,
            "vlanPrioEditEnable": true,
            "vlanEnableEditEnable": true
        }
    },
    "lan_mode": ["internet", "internet", "internet", "internet"],
    "lan_edit": [true, true, true, true]
}
);
var lanset = new Array(
{
	"id": "1",
	"displayName": "LAN1"
},
{
	"id": "2",
	"displayName": "LAN2"
},
{
	"id": "3",
	"displayName": "LAN3"
},
{
	"id": "4",
	"displayName": "LAN4"
}
);
var services = new Array(
{
	"name": "internet",
	"displayName": "Internet",
    "showTagOption": true
},
{
	"name": "ipphone",
	"displayName": "IP-Phone"
},
{
	"name": "iptv",
	"displayName": "IPTV"
},
{
	"name": "multicast",
	"displayName": "Multicast",
	"lanSelectable": false,
    "showEnableOption": true,
    "enableCb": "multicastEnableClick()"
}
);

function multicastEnableClick()
{
    if($.id("multicastvlanEnable").checked)
    {
        $.removeClass($.id("div_serv_multicast"),"vidDisable");
        $.removeClass($.id("div_serv_multicast"),"vpriDisable");
        $.id("multicast_vlanid").disabled = false;
        $.id("multicast_vlanprio").disabled = false;
    }
    else
    {
        $.addClass($.id("div_serv_multicast"),"vidDisable");
        $.addClass($.id("div_serv_multicast"),"vpriDisable");
        $.id("multicast_vlanid").disabled = true;
        $.id("multicast_vlanprio").disabled = true;
    }
}

function initLanOption()
{
	$.id("lan_setting").innerHTML = "";
	for(var lanIdx in lanset)
	{
		var p = $.c("p");
        p.setAttribute("class","L1");
        p.setAttribute("id","div_lan" + lanset[lanIdx]["id"]);

		var b = $.c("b");
        b.setAttribute("class","item T");
		b.innerHTML = lanset[lanIdx]["displayName"] + ":";
		p.appendChild(b);

		var sel = $.c("select");
        sel.setAttribute("class","S");
        sel.setAttribute("id","lan"+lanset[lanIdx]["id"]);
		for (var servIdx in services)
	    {
	    	if (services[servIdx]["lanSelectable"] === false)
	    		continue;

	        var opt = $.c("option");
            opt.setAttribute("value", services[servIdx].name);
            opt.setAttribute("id", "lan" + lanset[lanIdx]["id"] + "_" + services[servIdx].name);
	        opt.text = services[servIdx].displayName;
	        try{sel.add(opt,null);}catch(e){sel.add(opt);}
	    }
	    p.appendChild(sel);
		$.id("lan_setting").appendChild(p);
	}
}

function refreshLanOption(obj)
{
    for(var lanIdx in lanset)
    {
        for (var servIdx in services)
        {
            if (services[servIdx]["lanSelectable"] === false)
                continue;
            if (obj.vlanSetting[services[servIdx].name].enable)
            {
                $.removeClass($.id("lan" + lanset[lanIdx]["id"] + "_" + services[servIdx].name),"nd");
            }
            else
            {
                $.addClass($.id("lan" + lanset[lanIdx]["id"] + "_" + services[servIdx].name),"nd");
            }
        }
    }
}
function initISPService()
{
	for (var servIdx in services)
    {

    	var p = $.c("p");
    	p.setAttribute("class","L1 nd");
    	p.setAttribute("id", "div_serv_" + services[servIdx]["name"])

		var b = $.c("b");
		b.setAttribute("class","item T vid");
		b.innerHTML = services[servIdx]["displayName"] + " VLAN ID:";
		p.appendChild(b);

		var input = $.c("input");
		input.setAttribute("type", "text");
		input.setAttribute("value", "0");
		input.setAttribute("id", services[servIdx]["name"] + "_vlanid");
		input.setAttribute("class", "text vid");
		input.setAttribute("size", "5");
		input.setAttribute("maxLength", "4");
		p.appendChild(input);

		var b = $.c("b");
		b.className = "T ispService vpri";
		b.innerHTML = services[servIdx]["displayName"] + " VLAN priority:";
		p.appendChild(b);

		var sel = $.c("select");
        sel.setAttribute("id", services[servIdx]["name"] + "_vlanprio");
        sel.setAttribute("class", "vpri");
		for(var prio = 0; prio < 8; prio++)
		{
			var opt = $.c("option");
	        opt.setAttribute("value", prio);
	        opt.text = prio;
	        try{sel.add(opt,null);}catch(e){sel.add(opt);}
		}

        p.appendChild(sel);

		if(services[servIdx]["showTagOption"] === true)
		{
			var input = $.c("input");
			input.setAttribute("type", "checkbox");
            input.setAttribute("id", services[servIdx]["name"]+"tagEnable");
            input.setAttribute("class", "tagEnable");
            p.appendChild(input);

            var b = $.c("b");
            b.setAttribute("class", "T tagEnable");
            b.innerHTML = "802.1Q Tag";
            p.appendChild(b);
		}

        if(services[servIdx]["showEnableOption"] === true)
        {
            var input = $.c("input");
            input.setAttribute("type", "checkbox");
            input.setAttribute("class", "vlanEnable");
            input.setAttribute("id", services[servIdx]["name"]+"vlanEnable");
            if (typeof services[servIdx].enableCb != undefined)
            {
                input.setAttribute("onclick", services[servIdx].enableCb);
            }

            p.appendChild(input);


            var b = $.c("b");
            b.setAttribute("class", "T vlanEnable");
            b.innerHTML = "Enable";
            p.appendChild(b);
        }

        $.id("ispService").appendChild(p);
    }
}

function initModeOptions()
{
    var obj = $.id("iptv_mode");
    for (var mode in default_mode_data)
    {
        var opt = $.c("option");
        opt.setAttribute("value", default_mode_data[mode].workingMode);
        opt.setAttribute("id", "t_mode_" + default_mode_data[mode].workingMode);
        opt.text = default_mode_data[mode].displayName;
        try{obj.add(opt,null);}catch(e){obj.add(opt);}
    }
}

function initVlanCfg(cb)
{
	vlanObj = $.act(ACT_GET, VLAN, null, null);
    ispService = $.act(ACT_GL, ISP_SERVICE, null, null);

    $.exe(cb);
}

function fillVlanCfg(ret)
{
	if(ret)
	{
		return;
	}
    if (vlanObj.enable == "1" && vlanObj.workingMode != "normal" && vlanObj.workingMode != "automatic" && vlanObj.workingMode != "")
        $.id("iptv_enable").checked = true;
    else
        $.id("iptv_enable").checked = false;
    initMode(vlanObj.workingMode);
}

function selectOptionByValue(obj, value){
    var exist = false;
    for (var i = 0; i < obj.length; i++)
    {
        if (obj.options[i].value == value)
        {
            exist = true;
            break;
        }
    }
    if (exist)
    {
        obj.value = value;
    }
    return exist;
}

function fillData()
{
    for(var servIdx in services)
    {
        if(servIdx == 0)/*internet*/
        {
            $.id(services[servIdx]["name"] + "_vlanid").value = vlanObj.internetGroupVlanID;
            $.id(services[servIdx]["name"] + "_vlanprio").value = vlanObj.internetGroupPriority;
            if(services[servIdx]["showTagOption"] === true)
            {
                $.id(services[servIdx]["name"] + "tagEnable").checked = vlanObj.internetUntag == "0";
            }
            for(var lanIdx in lanset)
            {
                if ((1 << lanIdx) & vlanObj.internetGroupLanPort)
                {
                    $.id("lan" + lanset[lanIdx]["id"]).value = services[servIdx]["name"]
                }
            }
        }
        else
        {
            for(var idx = 0; idx < ispService.length; idx++)
            {
                if (services[servIdx]["name"] == ispService[idx].name)
                {
                    $.id(services[servIdx]["name"] + "_vlanid").value = ispService[idx].vlanID;
                    $.id(services[servIdx]["name"] + "_vlanprio").value = ispService[idx].priority;

                    if(services[servIdx]["showEnableOption"] === true)
                    {
                        $.id(services[servIdx]["name"] + "vlanEnable").checked = (ispService[idx].enable == "1");
                        if($.id(services[servIdx]["name"] + "vlanEnable").onclick != null)
                        {
                            $.id(services[servIdx]["name"] + "vlanEnable").onclick();
                        }
                    }

                    for(var lanIdx in lanset)
                    {
                        if ((1 << lanIdx) & ispService[idx].lanPort)
                        {
                            $.id("lan" + lanset[lanIdx]["id"]).value = services[servIdx]["name"]
                        }
                    }
                    break;
                }
            }

        }
    }
}

function initMode(mode)
{
    if(selectOptionByValue($.id("iptv_mode"), mode))
    {
        showMode();
        fillData();
    }
    else if(mode == "automatic" || mode == "normal" || mode == "")
    {
        showMode();
    }
}

function showDefaultData(obj)
{
    for(var servIdx in services)
    {
        if (obj.vlanSetting[services[servIdx].name].show == false)
        {
            $.addClass($.id("div_serv_" + services[servIdx].name),"nd")
        }
        else
        {
            $.removeClass($.id("div_serv_" + services[servIdx].name),"nd")
        }
        $.id(services[servIdx]["name"] + "_vlanid").value = obj.vlanSetting[services[servIdx].name].vlanID;
        $.id(services[servIdx]["name"] + "_vlanprio").value = obj.vlanSetting[services[servIdx].name].priority;
        if (obj.vlanSetting[services[servIdx].name].vlanIdEditEnable == false)
        {
        	$.addClass($.id("div_serv_" + services[servIdx].name), "vidDisable");
        	$.id(services[servIdx]["name"] + "_vlanid").disabled = true;
        }
        else
        {
        	$.removeClass($.id("div_serv_" + services[servIdx].name), "vidDisable");
        	$.id(services[servIdx]["name"] + "_vlanid").disabled = false;
        }

        if (obj.vlanSetting[services[servIdx].name].vlanPrioEditEnable == false)
        {
        	$.addClass($.id("div_serv_" + services[servIdx].name), "vpriDisable");
        	$.id(services[servIdx]["name"] + "_vlanprio").disabled = true;
        }
        else
        {
        	$.removeClass($.id("div_serv_" + services[servIdx].name), "vpriDisable");
        	$.id(services[servIdx]["name"] + "_vlanprio").disabled = false;
        }

        if(services[servIdx]["showTagOption"] === true)
        {
            $.id(services[servIdx]["name"] + "tagEnable").checked = obj.vlanSetting[services[servIdx].name].untag == "0";
        	if (obj.vlanSetting[services[servIdx].name].vlanTagEditEnable == false)
        	{
        		$.id(services[servIdx]["name"] + "tagEnable").disabled = true;
        		$.addClass($.id("div_serv_" + services[servIdx].name), "vlanTagDisable");
        	}
        	else
        	{
        		$.id(services[servIdx]["name"] + "tagEnable").disabled = false;
        		$.removeClass($.id("div_serv_" + services[servIdx].name), "vlanTagDisable");
        	}
        }
        if(services[servIdx]["showEnableOption"] === true)
        {
            $.id(services[servIdx]["name"] + "vlanEnable").checked = obj.vlanSetting[services[servIdx].name].enable == true;
            if (obj.vlanSetting[services[servIdx].name].vlanEnableEditEnable == false)
        	{
        		$.id(services[servIdx]["name"] + "vlanEnable").disabled = true;
        		$.addClass($.id("div_serv_" + services[servIdx].name), "vlanDisable");
        	}
        	else
        	{
        		$.id(services[servIdx]["name"] + "vlanEnable").disabled = false;
        		$.removeClass($.id("div_serv_" + services[servIdx].name), "vlanDisable");
        	}
            if($.id(services[servIdx]["name"] + "vlanEnable").onclick != null)
            {
            	$.id(services[servIdx]["name"] + "vlanEnable").onclick();
            }
        }
    }
    for(var lanIdx in lanset)
    {
        $.id("lan" + lanset[lanIdx]["id"]).value = obj.lan_mode[lanIdx];
        $.id("lan" + lanset[lanIdx]["id"]).disabled = obj.lan_edit[lanIdx] == false;
        if(obj.lan_edit[lanIdx] == false)
        {
            $.addClass($.id("div_lan" + lanset[lanIdx]["id"]),"iptv_disable");
        }
        else
        {
            $.removeClass($.id("div_lan" + lanset[lanIdx]["id"]),"iptv_disable");
        }

    }
    refreshLanOption(obj);
}

function showMode()
{
    if ($.id("iptv_enable").checked == false)
    {
        showDefaultData(noIptvData);
        $.addClass($.id("iptv_mode_div"),"nd");
        return;
    }

    var mode = $.id("iptv_mode").value;
    $.removeClass($.id("iptv_mode_div"),"nd");
    for (var modeIdx in default_mode_data)
    {
        if (mode == default_mode_data[modeIdx].workingMode)
        {
            showDefaultData(default_mode_data[modeIdx]);
        }
    }
    
}

function doCheckData(obj)
{
    if (obj.vlanSetting[services[0].name].lanPort == 0)
    {
        $.alert(ERR_VLAN_NO_INTERNET_GROUP);
        return false;
    }

    for (var i = 0; i < services.length; i++)
    {
        if (obj.vlanSetting[services[i].name].show != false && obj.vlanSetting[services[i].name].enable == true)
        {
            if ($.num(obj.vlanSetting[services[i].name].vlanID, [2, 4094], true))
            {
                $.alert(ERR_VLAN_INVALID_VLANID);

                $.id(services[i].name+"_vlanid").focus();
                $.id(services[i].name+"_vlanid").select();
        
                return false;
            }
        }
    }
    for (var i = 0; i < services.length - 1; i++)
    {
        if (obj.vlanSetting[services[i].name].show == false || obj.vlanSetting[services[i].name].enable == false)
        {
            continue;
        }

        for (var j = i + 1; j < services.length; j++)
        {
            if (obj.vlanSetting[services[j].name].show == false || obj.vlanSetting[services[j].name].enable == false)
            {
                continue;
            }
            if(obj.vlanSetting[services[i].name].vlanID == obj.vlanSetting[services[j].name].vlanID)
            {
                $.alert(ERR_VLAN_SAME_VLANID);
                if ($.id(services[i].name+"_vlanid").disabled)
                {
                    $.id(services[j].name+"_vlanid").focus();
                    $.id(services[j].name+"_vlanid").select();
                }
                else
                {
                    $.id(services[i].name+"_vlanid").focus();
                    $.id(services[i].name+"_vlanid").select();
                }
                return false;
            }
        }
    }
    return true;
}

function loadIgmpCfg() {
    var igmpCfg = $.act(ACT_GL, LAN_IGMP_SNOOP, null, null, ["enabled"]);
    var wanIPv4ListAll = $.act(ACT_GL, WAN_IP_CONN, null, null, ["enable", "addressingType", "X_TP_IPv4Enabled", "X_TP_BpaEnable", "X_TP_IGMPProxyEnabled", "X_TP_IGMPForceVersion"]);
    var wanIPList = {};
    var wanIndex = 0;

    if (!$.exe()) {
        $.each(wanIPv4ListAll, function() {
            if (this.X_TP_IPv4Enabled == 1) {
                wanIPList[wanIndex] = this;
                wanIndex++;
            }
        });
    }

    $.id("igmp_snooping_enable").checked = (igmpCfg[0].enabled == 1) ? 1 : 0;
    $.id("igmp_proxy_enable").checked = wanIPList[0].X_TP_IGMPProxyEnabled == "1";
    $.id("igmp_version").value = wanIPList[0].X_TP_IGMPForceVersion;
    //changeIgmpStatus();
}

function setIgmpCfg() {
    var igmp_state = $.id("igmp_proxy_enable").checked ? "1" : "0";
    var igmp_version = $.id("igmp_version").value;
    var igmp_snooping = $.id("igmp_snooping_enable").checked ? "1" : "0";


    /* set all WAN connection IGMP status */
    var igmpCfg = $.act(ACT_GL, LAN_IGMP_SNOOP, null, null, ["enabled"]);
    var wanIPListAll = $.act(ACT_GL, WAN_IP_CONN, null, null, ["enable", "X_TP_IPv4Enabled", "X_TP_BpaEnable", "X_TP_IGMPProxyEnabled", "X_TP_IGMPForceVersion"]);
    var wanPPPListAll = $.act(ACT_GL, WAN_PPP_CONN, null, null, ["enable", "X_TP_IPv4Enabled", "X_TP_IGMPProxyEnabled", "X_TP_IGMPForceVersion"]);
    var wanL2tpList = $.act(ACT_GL, WAN_L2TP_CONN, null, null, ["enable", "IGMPProxyEnabled", "IGMPForceVersion"]);
    var wanPptpList = $.act(ACT_GL, WAN_PPTP_CONN, null, null, ["enable", "IGMPProxyEnabled", "IGMPForceVersion"]);

    if (!$.exe()) {
        /* wanIpConnection */
        $.each(wanIPListAll, function() {
            if (this.X_TP_IPv4Enabled == 1) {
                $.act(ACT_SET, WAN_IP_CONN, this.__stack, null, ["X_TP_IGMPProxyEnabled=" + igmp_state, "X_TP_IGMPForceVersion=" + igmp_version]);
            }
        });

        /* wanPPPConnection */
        $.each(wanPPPListAll, function() {
            if (this.X_TP_IPv4Enabled == 1) {
                $.act(ACT_SET, WAN_PPP_CONN, this.__stack, null, ["X_TP_IGMPProxyEnabled=" + igmp_state, "X_TP_IGMPForceVersion=" + igmp_version]);
            }
        });

        /* L2TP */
        $.each(wanL2tpList, function() {
            $.act(ACT_SET, WAN_L2TP_CONN, this.__stack, null, ["IGMPProxyEnabled=" + igmp_state, "IGMPForceVersion=" + igmp_version]);
        });

        /* PPTP */
        $.each(wanPptpList, function() {
            $.act(ACT_SET, WAN_PPTP_CONN, this.__stack, null, ["IGMPProxyEnabled=" + igmp_state, "IGMPForceVersion=" + igmp_version]);
        });

        $.act(ACT_SET, LAN_IGMP_SNOOP, igmpCfg[0].__stack, null, ["enabled=" + igmp_snooping]);
        if (!$.exe()) {
            /* set succcess, nothing to do */
        }
    }
}

function setVlanCfg(obj, doAct)
{
    var lanPort = 0;
    var needReboot = false;

    for (var j = 0; j < ispService.length; j++)
    {
        var found = false;
        for (var i = 1; i < services.length; i++)
        {
            if(services[i].name == ispService[j].name)
            {
                found = true;
                break;
            }
        }

        if(!found)
        {
            if (ispService[j].enable == "1")
            {
                needReboot = true;
            }
            if (doAct)
            $.act(ACT_DEL, ISP_SERVICE, ispService[j].__stack);
        } 
    }
    
    for (var i = 1; i < services.length; i++)
    {
        var ispObj = {};
        var found = false;
        ispObj.name = services[i].name;
        ispObj.enable = obj.vlanSetting[services[i].name].enable ? "1" : "0";
        ispObj.vlanID = obj.vlanSetting[services[i].name].vlanID;
        ispObj.priority = obj.vlanSetting[services[i].name].priority;
        ispObj.extendID = obj.vlanSetting[services[i].name].extendID;
        ispObj.untag = obj.vlanSetting[services[i].name].untag;
        ispObj.lanPort = obj.vlanSetting[services[i].name].lanPort;

        lanPort += ispObj.lanPort;

        for (var j = 0; j < ispService.length; j++)
        {
            if(services[i].name == ispService[j].name)
            {
                found = true;
                if (ispObj.enable != ispService[j].enable ||
                    ispObj.vlanID != ispService[j].vlanID ||
                    ispObj.priority != ispService[j].priority ||
                    ispObj.extendID != ispService[j].extendID ||
                    ispObj.untag != ispService[j].untag ||
                    ispObj.lanPort != ispService[j].lanPort
                    )
                {
                    needReboot = true;
                }
                if (doAct)
                $.act(ACT_SET, ISP_SERVICE, ispService[j].__stack, null, ispObj);
                break;
            }
        }
        if (!found)
        {
            if (ispObj.enable != "0")
            {
                needReboot = true;
            }
            if (doAct)
            $.act(ACT_ADD, ISP_SERVICE, null, null, ispObj);
        }
    }

    var tmpObj = {};

    tmpObj.workingMode = obj.workingMode;
    tmpObj.enable = /*$.id("iptv_enable").checked ? "1" : "0"*/"1";
    tmpObj.internetGroupVlanID = obj.vlanSetting[services[0].name].vlanID;
    tmpObj.internetGroupExtendID = obj.vlanSetting[services[0].name].extendID;
    tmpObj.internetGroupPriority = obj.vlanSetting[services[0].name].priority;
    tmpObj.internetGroupLanPort = 255 - lanPort;
    tmpObj.internetUntag = obj.vlanSetting[services[0].name].untag;

    if ((tmpObj.workingMode != vlanObj.workingMode && vlanObj.workingMode != "") ||
		(tmpObj.workingMode != "automatic" && vlanObj.workingMode == "") ||
        tmpObj.enable != vlanObj.enable ||
        tmpObj.internetGroupVlanID != vlanObj.internetGroupVlanID ||
        tmpObj.internetGroupExtendID != vlanObj.internetGroupExtendID ||
        tmpObj.internetGroupPriority != vlanObj.internetGroupPriority ||
        tmpObj.internetGroupLanPort != vlanObj.internetGroupLanPort ||
        tmpObj.internetUntag != vlanObj.internetUntag
        )
    {
        needReboot = true;
    }
    if (doAct)
    {
        $.act(ACT_SET, VLAN, null, null, tmpObj);
        $.exe();
    }
    
    return needReboot;
}
function getDefaultCfg(mode){
    var result = {};
    var hasMode = false;
    var defaultVlanCfg = {};
    for(var modeIdx in default_mode_data)
    {
        if (default_mode_data[modeIdx].workingMode == mode)
        {
            hasMode = true;
            break;
        }
    }

    if (hasMode)
    {
        defaultVlanCfg = default_mode_data[modeIdx];
        
    }
    else
    {
        defaultVlanCfg = noIptvData;
    }

    result.workingMode = defaultVlanCfg.workingMode;
    result.vlanSetting = {};
    for (var servIdx in services)
    {
        result["vlanSetting"][services[servIdx].name] = {};
        result["vlanSetting"][services[servIdx].name].enable = defaultVlanCfg.vlanSetting[services[servIdx].name].enable;
        result["vlanSetting"][services[servIdx].name].vlanID = defaultVlanCfg.vlanSetting[services[servIdx].name].vlanID;
        result["vlanSetting"][services[servIdx].name].priority = defaultVlanCfg.vlanSetting[services[servIdx].name].priority;
        result["vlanSetting"][services[servIdx].name].extendID = defaultVlanCfg.vlanSetting[services[servIdx].name].extendID;
        result["vlanSetting"][services[servIdx].name].untag = defaultVlanCfg.vlanSetting[services[servIdx].name].untag;
        result["vlanSetting"][services[servIdx].name].show = defaultVlanCfg.vlanSetting[services[servIdx].name].show;
        result["vlanSetting"][services[servIdx].name].lanPort = defaultVlanCfg.vlanSetting[services[servIdx].name].lanPort ? defaultVlanCfg.vlanSetting[services[servIdx].name].lanPort : 0;
    }

    return result;
}

function saveCfg(obj)
{
    
    setVlanCfg(obj, true);
    setIgmpCfg();
}

function doCollectData(obj)
{
    for(var servIdx in services)
    {
        if (services[servIdx].showEnableOption == true)
        {
            obj.vlanSetting[services[servIdx].name].enable = $.id(services[servIdx].name + "vlanEnable").checked;
        }

        obj.vlanSetting[services[servIdx].name].vlanID = $.id(services[servIdx].name + "_vlanid").value;
        obj.vlanSetting[services[servIdx].name].priority = $.id(services[servIdx].name + "_vlanprio").value;

        if (services[servIdx].showTagOption == true)
        {
            obj.vlanSetting[services[servIdx].name].untag = $.id(services[servIdx].name + "tagEnable").checked ? 0: 1;
        }
    }
    for(var lanIdx in lanset)
    {
        obj.vlanSetting[$.id("lan" + lanset[lanIdx].id).value].lanPort += (1 << lanIdx);
    }
}
function doSave()
{
    var mode = $.id("iptv_mode").value;
    var needReboot = false;
    var tmp = {};
    if($.id("iptv_enable").checked)
    {
        tmp = getDefaultCfg(mode);
        doCollectData(tmp);
    }
    else
    {
        tmp = getDefaultCfg("automatic");
    }

    if(doCheckData(tmp) == false)
        return;

    needReboot = setVlanCfg(tmp);

    if(needReboot == true)
    {
        if (!confirm(c_str.save_reboot)) {
            return;
        }
    }
    
    saveCfg(tmp);

    $.exe(function(ret) {
        if (!ret) {
           if (needReboot == true) {
                /* reboot */
                $.guage(["<span class='T T_rebooting'>" + s_str.rebooting + "</span>", "<span class='T T_wait_reboot'>" + s_str.wait_reboot + "</span>", ], 100, $.guageInterval, function() {
                    window.parent.$.refresh();
                });
                $.act(ACT_OP, ACT_OP_REBOOT);
                $.exe(true);
            
            } else {
                $.reload();
            }
        }
    });
}

function doCollect() {
	var mode = $.id("iptv_mode").value;
    var tmp = {};
    if($.id("iptv_enable").checked)
    {
        tmp = getDefaultCfg(mode);
        doCollectData(tmp);
    }
    else
    {
        tmp = getDefaultCfg("automatic");
    }
    $.qd.vlan = tmp;
    $.qd.vlan_ispService = ispService;
    $.qd.vlan_services = services;
    return tmp;
}
function goPrev() {
	doCollect();
	$.qf.prev();	
}
function goNext() {
	var tmp;
	tmp = doCollect();
	if(doCheckData(tmp) == false)
    return;
    $.qf.next();
}
</script>
<style type="text/css">
b.item 
{
	width: 30% !important;
}
b.ispService
{
	width:150px;
	display:inline-block;
	text-align:right;
	padding-right: 16px;
}
p.iptv_disable b, p.iptv_disable select, p.iptv_disable input
{
    color: #b3b3b3;
}
p.vidDisable .vid, p.vpriDisable .vpri, p.vlanTagDisable .tagEnable, p.vlanDisable .vlanEnable
{
    color: #b3b3b3;
}
</style>
<div class="con1 M">
    <p class="et" id="t_et">Quick Setup - IPTV</p>
    <p class="bl"></p>
    <div class="con2">
        <p class="br"></p>
        <p class="L1 nd">
            <b class="item T">IGMP Snooping:</b>
            <input id="igmp_snooping_enable" type="checkbox" onclick="" />
            <span id="t_igmp_snooping_enable" class="T T_en">Enable</span>
        </p>

        <p class="L1 nd">
            <b class="item T">IGMP Proxy:</b>
            <input id="igmp_proxy_enable" type="checkbox" onclick="" />
            <span id="t_igmp_proxy_enable" class="T T_en">Enable</span>
        </p>

        <p class="L1 nd" id="igmp_version_select">
            <b class="item T" id="t_igmp_version">IGMP Version:</b>
            <select class="L" id="igmp_version" onchange="">
                <option value="2" class="T" id="igmp_v2">V2</option>
                <option value="0" class="T" id="igmp_v3">V3</option>
            </select>
        </p>

        <p class="L1">
            <b class="item T">IPTV:</b>
            <input id="iptv_enable" type="checkbox" onclick="showMode()" />
            <span id="t_iptv_enable">Enable IPTV</span>
        </p>

        <p class="L1 nd" id="iptv_mode_div">
            <b class="item T" id="t_iptv_mode">IPTV Mode:</b>
            <select class="L" id="iptv_mode" onchange="showMode();">
            </select>
        </p>

		<p class="br"></p>

		<div id="ispService"></div>

     	<p class="br"></p>

		<div id="lan_setting"></div>

        <p class="bl"></p>
        <p class="tail ctr" id="tail">
        <!--<input type="button" class="button L T T_save" value="Save" id="b_save" onclick="doSave();" />-->
        <input type="button" class="button L T T_back" value="Back" onclick="goPrev()" />
		<input type="button" class="button L T T_next" value="Next" onclick="goNext()" />
        </p>
    </div>
</div>
<script language="javascript" type="text/javascript">
(function() {
    initModeOptions();
    initISPService();
    initLanOption();
	initVlanCfg(fillVlanCfg);
    loadIgmpCfg();
    $.loadHelpFrame("qsIptvHelp.htm");
})();
</script>
